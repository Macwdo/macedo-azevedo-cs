<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/macwdo/Work/MacedoAzevedo/Macedo-azevedo-cs/Ma.API/Startup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using FluentValidation;
using Ma.Api.Validators.Registry;
using Ma.API.Clients;
using Ma.API.Data;
using Ma.API.Middlewares;
using Ma.API.Models.Lawsuit;
using Ma.API.Models.Lawyer;
using Ma.API.Models.Registry;
using Ma.API.Repository;
using Ma.API.Services;
using Ma.API.Validators.Lawyer;
using Microsoft.OpenApi.Models;
using Serilog;
using Swashbuckle.AspNetCore.SwaggerGen;

namespace Ma.API;

public class Startup
{

    public IConfiguration Configuration { get; }

    public Startup(IConfiguration configuration)
    {
        Configuration = configuration;
    }

    public void ConfigureServices(IServiceCollection services)
    {

        #region Controllers
        services.AddControllers();
        services.AddEndpointsApiExplorer();
        services.AddSwaggerGen();

        #endregion

        // TODO: Configure Health checks
        #region HealthChecks
        ConfigureHealthChecks(services);

        #endregion

        #region Loggers
        ConfigureLogging(services);

        #endregion

        #region Services DI

        ConfigureDiServices(services);

        ConfigureValidators(services);

        ConfigureHttpClients(services);

        #endregion

        #region Middlewares

        ConfigureMiddlewares(services);

        #endregion

        #region Database
        ConfigureDatabase(services);

        #endregion

        #region AutoMapper
        ConfigureAutoMapper(services);

        #endregion

    }

    private void ConfigureHealthChecks(IServiceCollection services)
    {

    }

    private void ConfigureLogging(IServiceCollection services)
    {
        // services.AddApplicationInsightsTelemetry();
    
       Log.Logger = new LoggerConfiguration()
            .WriteTo.Console()
            .WriteTo.File(&quot;logs/log.txt&quot;, rollingInterval: RollingInterval.Day)
            .CreateLogger();

        services.AddLogging(loggingBuilder =&gt; loggingBuilder.AddSerilog());

        // TODO: Test better log solution ELK, Sentry or ApplicationInsights;             
        // ConfigureLogging(services);
        // builder.WebHost.UseSentry();

    }

    private void ConfigureDiServices(IServiceCollection services)
    {
        services.AddScoped&lt;IRegistryService, RegistryService&gt;();
        services.AddScoped&lt;ILawsuitService, LawsuitService&gt;();
        services.AddScoped(typeof(IGenericCrudService&lt;,,,&gt;), typeof(GenericCrudService&lt;,,,&gt;));

    }

    private void ConfigureValidators(IServiceCollection services){
        services.AddScoped&lt;IValidator&lt;CreateLawyerDto&gt;, CreateLawyerDtoValidator&gt;();
        services.AddScoped&lt;IValidator&lt;UpdateLawyerDto&gt;, UpdateLawyerDtoValidator&gt;();

        services.AddScoped&lt;IValidator&lt;CreateRegistryDto&gt;, CreateRegistryDtoValidator&gt;();
    }

    private void ConfigureHttpClients(IServiceCollection services)
    {
        services.AddHttpClient&lt;IApiHelper, ApiHelper&gt;(client =&gt; {
            client.DefaultRequestHeaders.Add(&quot;Accept&quot;, &quot;application/json&quot;);
            client.DefaultRequestHeaders.Add(&quot;ContentType&quot;, &quot;application/json&quot;);

            client.BaseAddress = new Uri(&quot;http://localhost:5000&quot;);
        });
    }

    private void ConfigureMiddlewares(IServiceCollection services)
    {
        services.AddTransient&lt;GlobalExceptionHandlingMiddleware&gt;();
    }

    private void ConfigureDatabase(IServiceCollection services)
    {
        services.AddScoped(typeof(IRepository&lt;&gt;), typeof(BaseRepository&lt;&gt;));

        var connectionString = Configuration.GetConnectionString(&quot;postgres&quot;);
        services.AddNpgsql&lt;ApplicationContext&gt;(connectionString);

    }

    private void ConfigureAutoMapper(IServiceCollection services)
    {
        services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());

    }

    public void Configure(IApplicationBuilder app, IHostEnvironment env)
    {
        app.UseRouting();

        app.UseHttpsRedirection();

        # region Middlewares
        app.UseMiddleware&lt;GlobalExceptionHandlingMiddleware&gt;();

        # endregion

        app.UseEndpoints(s =&gt;
        {
            s.MapControllers();
        });

        if (env.IsDevelopment())
        {
            app.UseSwagger();
            app.UseSwaggerUI();
        }


    }



}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,43,21,47,0],[23,5,23,49,0],[24,5,24,6,0],[25,9,25,39,0],[26,5,26,6,0],[29,5,29,6,0],[32,9,32,35,0],[33,9,33,44,0],[34,9,34,34,0],[40,9,40,41,0],[45,9,45,36,0],[51,9,51,39,0],[53,9,53,39,0],[55,9,55,40,0],[61,9,61,40,0],[66,9,66,37,0],[71,9,71,39,0],[75,5,75,6,0],[78,5,78,6,0],[80,5,80,6,0],[83,5,83,6,0],[86,8,89,29,0],[91,9,91,47,0],[91,47,91,74,0],[91,74,91,76,0],[97,5,97,6,0],[100,5,100,6,0],[101,9,101,65,0],[102,9,102,63,0],[103,9,103,95,0],[105,5,105,6,0],[107,66,107,67,0],[108,9,108,85,0],[109,9,109,85,0],[111,9,111,89,0],[112,5,112,6,0],[115,5,115,6,0],[116,9,116,65,0],[116,65,116,66,0],[116,66,117,13,0],[117,13,117,76,0],[117,76,118,13,0],[118,13,118,81,0],[118,81,120,13,0],[120,13,120,67,0],[120,67,121,9,0],[121,9,121,10,0],[121,10,121,12,0],[122,5,122,6,0],[125,5,125,6,0],[126,9,126,68,0],[127,5,127,6,0],[130,5,130,6,0],[131,9,131,77,0],[133,9,133,78,0],[134,9,134,66,0],[136,5,136,6,0],[139,5,139,6,0],[140,9,140,73,0],[142,5,142,6,0],[145,5,145,6,0],[146,9,146,26,0],[148,9,148,35,0],[151,9,151,64,0],[155,9,156,9,0],[156,9,156,10,0],[156,10,157,13,0],[157,13,157,32,0],[157,32,158,9,0],[158,9,158,10,0],[158,10,158,12,0],[160,9,160,33,0],[161,9,161,10,0],[162,13,162,30,0],[163,13,163,32,0],[164,9,164,10,0],[167,5,167,6,0]]);
    </script>
  </body>
</html>