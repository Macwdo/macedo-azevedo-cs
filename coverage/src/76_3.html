<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/macwdo/Work/MacedoAzevedo/Macedo-azevedo-cs/Ma.Api.Test/System/UnitTests/Services/RegistryServiceTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using AutoMapper;
using FluentAssertions;
using FluentValidation;
using Ma.API.Entities;
using Ma.API.Exceptions;
using Ma.API.Models.Registry;
using Ma.API.Repository;
using Ma.API.Services;
using Ma.Api.Test.Fixtures.Entities;
using Ma.Api.Validators.Registry;
using Microsoft.Extensions.Logging;
using Moq;

namespace Ma.Api.Test.System.UnitTests.Services;

public class RegistryServiceTest
{

    private ReadRegistryDto MapRegistryToReadRegistryDto(Registry registry)
    {
        return new ReadRegistryDto(
            registry.Id,
            registry.Name,
            registry.Email,
            registry.Image,
            null,
            registry.CreatedAt,
            registry.UpdatedAt
        );
    }

    [Fact]
    public void GetRegistry_OnSuccess_ReturnsReadRegistryDto()
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Get(1))
            .Returns(registryFixture);

        var readRegistryDtoFixture = MapRegistryToReadRegistryDto(registryFixture);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        mockAutoMapper
            .Setup(a =&gt; a.Map&lt;ReadRegistryDto&gt;(registryFixture))
            .Returns(readRegistryDtoFixture);

        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new Mock&lt;IValidator&lt;CreateRegistryDto&gt;&gt;();
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator.Object
        );

        // Act
        var readRegistryDto = registryService.GetRegistry(1);

        // Assert
        readRegistryDto.Should().Be(readRegistryDtoFixture);

    }

    [Fact]
    public void GetRegistry_OnNotFound_ReturnsNull()
    {
        // Arrange
        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Get(1))
            .Returns((Registry?)null);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new Mock&lt;IValidator&lt;CreateRegistryDto&gt;&gt;();
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator.Object
        );

        // Act
        var getRegistryResult = registryService.GetRegistry(1);

        // Assert
        getRegistryResult.Should().BeNull();

    }

    [Fact]
    public void GetRegistries_OnSuccess_ReturnsReadRegistryDtoList()
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.GetAllReadOnly())
            .Returns(new List&lt;Registry&gt; { registryFixture });

        var readRegistryDtoFixture = MapRegistryToReadRegistryDto(registryFixture);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        mockAutoMapper
            .Setup(a =&gt;
                a.Map&lt;IEnumerable&lt;ReadRegistryDto&gt;&gt;(new List&lt;Registry&gt; { registryFixture })
                )
            .Returns(new List&lt;ReadRegistryDto&gt; { readRegistryDtoFixture });

        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new Mock&lt;IValidator&lt;CreateRegistryDto&gt;&gt;();
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator.Object
        );
        // Act
        var readRegistryDtoList = registryService.GetRegistries();

        // Assert
        readRegistryDtoList.Should().BeEquivalentTo(new List&lt;ReadRegistryDto&gt; { readRegistryDtoFixture });

    }

    [Fact]
    public void CreateRegistry_OnSuccess_ReturnsReadRegistryDto()
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Create(registryFixture))
            .Returns(registryFixture);

        var createRegistryDtoFixture = new CreateRegistryDto(
            registryFixture.Name,
            registryFixture.Email,
            registryFixture.Image,
            null
        );

        var readRegistryDtoFixture = MapRegistryToReadRegistryDto(registryFixture);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();

        mockAutoMapper
            .Setup(a =&gt; a.Map&lt;Registry&gt;(createRegistryDtoFixture))
            .Returns(registryFixture);

        mockAutoMapper
            .Setup(a =&gt; a.Map&lt;ReadRegistryDto&gt;(registryFixture))
            .Returns(readRegistryDtoFixture);

        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new CreateRegistryDtoValidator();

        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator
        );

        // Act
        var readRegistryDto = registryService.CreateRegistry(createRegistryDtoFixture);

        // Assert
        readRegistryDto.Should().Be(readRegistryDtoFixture);

    }

    [Theory]
    [InlineData(&quot;Valid Name&quot;, &quot;valid_email@mail.com&quot;, &quot;https://validimageurl.com/&quot;, true)]
    [InlineData(&quot;in&quot;, &quot;notvalidemail&quot;, &quot;https://validimageurl.com/&quot;, false)]
    public void CreateRegistry_OnRightFields_ShouldCreate(string name, string email, string image, bool valid)
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        registryFixture.Name = name;
        registryFixture.Email = email;
        registryFixture.Image = new (image);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Create(registryFixture))
            .Returns(registryFixture);

        var createRegistryDtoFixture = new CreateRegistryDto(
            registryFixture.Name,
            registryFixture.Email,
            registryFixture.Image,
            null
        );

        var readRegistryDtoFixture = MapRegistryToReadRegistryDto(registryFixture);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        mockAutoMapper
            .Setup(a =&gt; a.Map&lt;Registry&gt;(createRegistryDtoFixture))
            .Returns(registryFixture);

        mockAutoMapper
            .Setup(a =&gt; a.Map&lt;ReadRegistryDto&gt;(registryFixture))
            .Returns(readRegistryDtoFixture);

        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var validator = new CreateRegistryDtoValidator();
        
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            validator
        );

        // Act
        Action createRegistryAction = () =&gt; registryService.CreateRegistry(createRegistryDtoFixture);

        // Assert
        if (valid)
            createRegistryAction.Should().NotThrow();
        else
            createRegistryAction.Should().Throw&lt;InvalidModelException&gt;();
    }

    [Fact]
    public void DeleteRegistry_WhenExists_ShouldNotThrow()
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Get(1))
            .Returns(registryFixture);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new Mock&lt;IValidator&lt;CreateRegistryDto&gt;&gt;();
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator.Object
        );

        // Act
        Action deleteRegistryAction = () =&gt; registryService.DeleteRegistry(1);

        // Assert
        deleteRegistryAction.Should().NotThrow();
    }

    [Fact]
    public void UpdateRegistry_WhenNotExists_ShouldThrow()
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Get(1))
            .Returns((Registry?)null);

        var updateRegistryDtoFixture = new UpdateRegistryDto(
            registryFixture.Name,
            registryFixture.Email,
            registryFixture.Image,
            null
        );

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new Mock&lt;IValidator&lt;CreateRegistryDto&gt;&gt;();
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator.Object
        );

        // Act
        Action updateRegistryAction = () =&gt; registryService.UpdateRegistry(1, updateRegistryDtoFixture);

        // Assert
        updateRegistryAction.Should().Throw&lt;NotFoundEntityException&gt;();
    }

    [Fact]
    public void UpdateRegistry_WhenExists_ShouldUpdate()
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Get(1))
            .Returns(registryFixture);

        var updateRegistryDtoFixture = new UpdateRegistryDto(
            $&quot;{registryFixture.Name} Updated&quot;,
            $&quot;email.update@mail.com&quot;,
            registryFixture.Image,
            null
        );

        registryFixture.Name = updateRegistryDtoFixture.Name!;
        registryFixture.Email = updateRegistryDtoFixture.Email;

        mockRegistryRepository
            .Setup(x =&gt; x.Update(registryFixture))
            .Returns(registryFixture);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        mockAutoMapper
            .Setup(a =&gt; a.Map(updateRegistryDtoFixture, registryFixture))
            .Returns(registryFixture);

        mockAutoMapper.
            Setup(a =&gt; a.Map&lt;ReadRegistryDto&gt;(registryFixture))
            .Returns(MapRegistryToReadRegistryDto(registryFixture));

        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new Mock&lt;IValidator&lt;CreateRegistryDto&gt;&gt;();
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator.Object
        );

        // Act
        var updatedRegistry = registryService.UpdateRegistry(1, updateRegistryDtoFixture);

        // Assert
        updatedRegistry.Name.Should().Be(updateRegistryDtoFixture.Name);
        updatedRegistry.Email.Should().Be(updateRegistryDtoFixture.Email);
    }

    [Fact]
    public void DeleteRegistry_WhenNotFound_ShouldThrow()
    {
        // Arrange
        var registryFixture = RegistryFixture.Registry(1);

        var mockRegistryRepository = new Mock&lt;IRepository&lt;Registry&gt;&gt;();
        mockRegistryRepository
            .Setup(x =&gt; x.Get(1))
            .Returns((Registry?)null);

        var mockAutoMapper = new Mock&lt;IMapper&gt;();
        var mockLogger = new Mock&lt;ILogger&lt;RegistryService&gt;&gt;();
        var mockValidator = new Mock&lt;IValidator&lt;CreateRegistryDto&gt;&gt;();
        var registryService = new RegistryService(
            mockRegistryRepository.Object,
            mockAutoMapper.Object,
            mockLogger.Object,
            mockValidator.Object
        );

        // Act
        Action deleteRegistryAction = () =&gt; registryService.DeleteRegistry(1);

        // Assert
        deleteRegistryAction.Should().Throw&lt;NotFoundEntityException&gt;();
    }


}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,5,20,6,0],[21,9,29,11,0],[30,5,30,6,0],[34,5,34,6,0],[36,9,36,59,0],[38,9,38,72,0],[39,9,41,39,0],[43,9,43,84,0],[45,9,45,50,0],[46,9,48,46,0],[50,9,50,63,0],[51,9,51,71,0],[52,9,57,11,0],[60,9,60,62,0],[63,9,63,61,0],[65,5,65,6,0],[69,5,69,6,0],[71,9,71,72,0],[72,9,74,39,0],[76,9,76,50,0],[77,9,77,63,0],[78,9,78,71,0],[79,9,84,11,0],[87,9,87,64,0],[90,9,90,45,0],[92,5,92,6,0],[96,5,96,6,0],[98,9,98,59,0],[100,9,100,72,0],[101,9,103,62,0],[105,9,105,84,0],[107,9,107,50,0],[108,9,112,76,0],[114,9,114,63,0],[115,9,115,71,0],[116,9,121,11,0],[123,9,123,67,0],[126,9,126,107,0],[128,5,128,6,0],[132,5,132,6,0],[134,9,134,59,0],[136,9,136,72,0],[137,9,139,39,0],[141,9,146,11,0],[148,9,148,84,0],[150,9,150,50,0],[152,9,154,39,0],[156,9,158,46,0],[160,9,160,63,0],[161,9,161,62,0],[163,9,168,11,0],[171,9,171,88,0],[174,9,174,61,0],[176,5,176,6,0],[182,5,182,6,0],[184,9,184,59,0],[186,9,186,37,0],[187,9,187,39,0],[188,9,188,45,0],[190,9,190,72,0],[191,9,193,39,0],[195,9,200,11,0],[202,9,202,84,0],[204,9,204,50,0],[205,9,207,39,0],[209,9,211,46,0],[213,9,213,63,0],[214,9,214,58,0],[216,9,221,11,0],[224,9,224,45,0],[224,45,224,101,0],[224,101,224,102,0],[227,9,227,19,0],[228,13,228,54,0],[230,13,230,74,0],[231,5,231,6,0],[235,5,235,6,0],[237,9,237,59,0],[239,9,239,72,0],[240,9,242,39,0],[244,9,244,50,0],[245,9,245,63,0],[246,9,246,71,0],[247,9,252,11,0],[255,9,255,45,0],[255,45,255,78,0],[255,78,255,79,0],[258,9,258,50,0],[259,5,259,6,0],[263,5,263,6,0],[265,9,265,59,0],[267,9,267,72,0],[268,9,270,39,0],[272,9,277,11,0],[279,9,279,50,0],[280,9,280,63,0],[281,9,281,71,0],[282,9,287,11,0],[290,9,290,45,0],[290,45,290,104,0],[290,104,290,105,0],[293,9,293,72,0],[294,5,294,6,0],[298,5,298,6,0],[300,9,300,59,0],[302,9,302,72,0],[303,9,305,39,0],[307,9,312,11,0],[314,9,314,63,0],[315,9,315,64,0],[317,9,319,39,0],[321,9,321,50,0],[322,9,324,39,0],[326,9,328,69,0],[330,9,330,63,0],[331,9,331,71,0],[332,9,337,11,0],[340,9,340,91,0],[343,9,343,73,0],[344,9,344,75,0],[345,5,345,6,0],[349,5,349,6,0],[351,9,351,59,0],[353,9,353,72,0],[354,9,356,39,0],[358,9,358,50,0],[359,9,359,63,0],[360,9,360,71,0],[361,9,366,11,0],[369,9,369,45,0],[369,45,369,78,0],[369,78,369,79,0],[372,9,372,72,0],[373,5,373,6,0]]);
    </script>
  </body>
</html>